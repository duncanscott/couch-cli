apply plugin: 'groovy'
apply plugin: 'maven'
apply plugin:'application'

sourceCompatibility = 1.7
mainClassName = 'net.duncanscott.couch_cli.client.CouchClient'

task wrapper(type:Wrapper) {
	gradleVersion = '1.11'
}

jar {
	manifest {
		attributes 'Implementation-Title': 'Couch-Cli', 'Implementation-Version': version
	}
}

repositories {
	mavenCentral()
}

dependencies {
	compile 'org.codehaus.groovy:groovy-all:2.2.2'
	compile 'log4j:log4j:1.2.17'
	compile 'org.codehaus.groovy.modules.http-builder:http-builder:0.7'
	compile 'commons-cli:commons-cli:1.2'
	
	testCompile "org.spockframework:spock-core:0.7-groovy-2.0"	
}

task gradleProperties {
	doLast {
		gradle.properties.keySet().sort().each { key ->
			println "${key}=${gradle.properties[key]}"
		}
	}
}

task gradleVersion {
	doLast {
		println "gradleVersion=${gradle.properties['gradleVersion']}"
	}
}

processResources {
	filter { String line -> 
		def matcher = line =~ /<%([^%]+)%>/
		matcher?.eachWithIndex { match, Integer index ->
			String prop = matcher[index][1]?.trim()
			String value  = project.properties[prop]
			if (value == null) {
				throw new RuntimeException("no property defined for substitution variable ${matcher[index][0]}")
			}
			line = matcher.replaceAll(value)
		}
		return line
	}
}

sourceSets {
	main {
		groovy {
			srcDir 'src/main/groovy'
		}
		resources {
			srcDir 'src/main/resources'
		}
	}
	test {
		groovy {
			srcDir 'src/test/groovy'
		}
		resources {
			srcDir 'src/test/resources'
		}
	}
}

tasks.withType(Test) { testTask ->
	afterTest { TestDescriptor descriptor, TestResult result ->
		long duration = result.endTime - result.startTime
		String logMessage = "${result.resultType} (${duration} msecs): ${testTask.name} ${descriptor.className} \"${descriptor.name}\""
		switch (result.resultType) {
			case TestResult.ResultType.SUCCESS:
				logger.info "${logMessage}"
				break;
			case TestResult.ResultType.FAILURE:
				logger.error "${logMessage}"
				break;
			case TestResult.ResultType.SKIPPED:
				logger.warn "${logMessage}"
				break;
			default:
				logger.warn "${logMessage}"
		}
	}
}
